# Report Updater (локальный)

Локальный, детерминированный апдейтер месячных отчетов МВД. Извлекает метрики и таблицы дел из Word (.docx), валидирует, и записывает значения в Excel (.xlsx) только в блок/колонку «МВД». Генерация разрешена **только при отсутствии блокирующих ошибок** (если не включен режим Skip validation).

## Быстрый старт (Windows)

```powershell
cd report_updater
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
streamlit run app/streamlit_app.py
```

Откройте браузер по адресу, который покажет Streamlit (обычно http://localhost:8501).

## Что делает приложение

1. Загружаете:
   - Word текущего месяца (.docx)
   - Excel прошлого месяца (.xlsx)
   - (опционально) Excel текущего месяца (.xlsx) — только для сравнения структуры
2. Нажимаете **Анализ**
3. Смотрите:
   - ошибки/предупреждения
   - извлеченные метрики
   - breakdown по статьям
   - preview diff (какие ячейки будут изменены)
4. Если ошибок нет — можно **Сформировать и скачать Excel**

## Жесткое правило записи (МВД)

- Лист «Отчет 1-Е Р.1»: блок «МВД» = колонки **H–K**
- Лист «Р.2»: колонка **E** = «МВД»
- Колонку «Пр. МВД» (обычно J) не трогаем
- Листы «Тит.лист» и «БАЗА» не являются целевыми для записи

## Конфиги

Все правила находятся в `report_updater/config/`:

- `metrics.yaml` — словарь фраз/regex для извлечения метрик из Word
- `metrics_required.yaml` — список обязательных метрик
- `cross_checks.yaml` — формулы cross-check
- `excel_map.yaml` — как метрики пишутся в Excel (лист + строка + колонка МВД)
- `article_map.yaml` — маппинг строк статей в Excel R.1
- `i18n_ru.yaml`, `i18n_kg.yaml` — тексты UI

### Пример правила метрики

```yaml
carry_over_cases:
  targets:
    - sheet: "Р.2"
      row_label_contains: "Остаток неоконченных уг.дел на начало отчетного периода"
      row_label_column: "B"
      col_key: "МВД"
```

## Валидации

Блокирующие ошибки:
- обязательные метрики не найдены
- cross-check не сходится
- целевая строка/колонка в Excel не найдена (ambiguous mapping)
- не найдено ни одной цели записи

Предупреждения:
- дубликаты метрик (берем последнюю)
- пустая дата регистрации / статья в таблице дел
- дубликаты case_id
- дела вне отчетного месяца

## Bootstrap diff (сравнение шаблонов)

Если есть заполненный `base_current.xlsx`, приложение покажет разницу значений в блоке МВД:
- R.2 (колонка МВД)
- R.1 (блок МВД)

Это помогает увидеть смещения строк или новые строки в текущем шаблоне.

## Отладочные JSON

После анализа создаются файлы в `report_updater/output/`:
- `extracted_metrics.json`
- `validation_report.json`
- `mapping_debug.json`

## Troubleshooting

- **«Не найдено ни одной цели записи»** — проверьте `excel_map.yaml` и реальные подписи строк в Excel (колонка B).
- **«Лист не найден»** — проверьте название листа в `excel_map.yaml`.
- **Cross-check не сходится** — сравните метрики и формулу, проверьте категории (все должны быть из одного блока отчета).
- **Ambiguous mapping** — в Excel есть несколько похожих строк; уточните `row_label_contains` или добавьте `row_code`.

## Тесты

```powershell
pytest -q
```
